<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Freelance Dashboard - Dashboard</title>

  <!-- External CSS -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>

  <!-- Project CSS -->
  <link rel="stylesheet" href="assets/css/styles.css"/>
</head>
<body>
  <!-- Topbar -->
  <header class="topbar">
    <div class="brand"><a href="index.html">Freelance Dashboard</a></div>

    <nav class="navlinks">
      <a href="index.html">Dashboard</a>
      <a href="users.html">Users</a>
      <a href="posts.html">Posts</a>
    </nav>

    <div class="controls">
      <label class="theme-label">
        <input id="themeToggle" type="checkbox" />
        <span>Dark</span>
      </label>
    </div>
  </header>

  <!-- Loader -->
  <div id="loader" class="loader" style="display:none;">
    <div class="loader-inner animate__animated animate__pulse">Loading</div>
  </div>

  <!-- Main content -->
  <main class="container">
    <h1 class="page-title">Dashboard</h1>

    <section class="cards">
      <div class="card animate__animated animate__fadeInUp" id="card-users">
        <div class="card-icon"><i class="fa fa-users"></i></div>
        <div class="card-body">
          <h3 id="countUsers">--</h3>
          <p>Users</p>
        </div>
      </div>

      <div class="card animate__animated animate__fadeInUp" id="card-posts">
        <div class="card-icon"><i class="fa fa-file-alt"></i></div>
        <div class="card-body">
          <h3 id="countPosts">--</h3>
          <p>Posts</p>
        </div>
      </div>

      <div class="card animate__animated animate__fadeInUp" id="card-comments">
        <div class="card-icon"><i class="fa fa-comments"></i></div>
        <div class="card-body">
          <h3 id="countComments">--</h3>
          <p>Comments</p>
        </div>
      </div>
    </section>
  </main>

  <footer class="footer" style="display:none;"></footer>

  <!-- Scripts: jQuery, DataTables, Toastr -->
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>

  <!-- App (includes seeded data helpers) -->
  <script src="assets/js/app.js"></script>

  <!-- Inline dashboard logic (uses fetchUsers(), fetchPosts(), fetchAllComments()) -->
  <script>
    (async function() {
      try {
        showLoader();
        const users = await fetchUsers();
        const posts = await fetchPosts();
        const comments = await fetchAllComments();

        const localUsers = JSON.parse(localStorage.getItem('users_local') || '[]');
        const localPosts = JSON.parse(localStorage.getItem('posts_local') || '[]');

        const localUsersMap = {};
        localUsers.forEach(u => localUsersMap[u.id] = u);
        const usersMerged = users
          .filter(u => !(localUsersMap[u.id] && localUsersMap[u.id].deleted))
          .map(u => ({...u, ...(localUsersMap[u.id] || {})}));
        const addedLocalUsers = localUsers.filter(u => u.id < 0 && !u.deleted);
        const finalUsers = usersMerged.concat(addedLocalUsers);

        const localPostsMap = {};
        localPosts.forEach(p => localPostsMap[p.id] = p);
        const postsMerged = posts
          .filter(p => !(localPostsMap[p.id] && localPostsMap[p.id].deleted))
          .map(p => ({...p, ...(localPostsMap[p.id] || {})}));
        const addedLocalPosts = localPosts.filter(p => p.id < 0 && !p.deleted);
        const finalPosts = postsMerged.concat(addedLocalPosts);

        $('#countUsers').text(finalUsers.length);
        $('#countPosts').text(finalPosts.length);
        $('#countComments').text(comments.length);

        $('#card-users h3, #card-posts h3, #card-comments h3').addClass('big-number');
      } catch (err) {
        console.error(err);
        toastr.error('Failed to load dashboard data');
      } finally {
        hideLoader();
      }
    })();
  </script>
</body>
</html>
